<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Spark Voice Portal - Technical Review</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; line-height: 1.6; }
    h1 { color: #1a73e8; border-bottom: 3px solid #1a73e8; padding-bottom: 10px; }
    h2 { color: #202124; margin-top: 30px; }
    h3 { color: #5f6368; }
    .subtitle { color: #5f6368; font-style: italic; margin-top: -10px; }
    .critical { color: #d93025; font-weight: bold; }
    .high { color: #ea8600; font-weight: bold; }
    .medium { color: #f9ab00; font-weight: bold; }
    .low { color: #1e8e3e; font-weight: bold; }
    .score { font-size: 24px; color: #ea8600; font-weight: bold; }
    .issue-box { background: #f8f9fa; border-left: 4px solid #d93025; padding: 15px; margin: 15px 0; }
    .issue-box.high { border-left-color: #ea8600; }
    .issue-box.medium { border-left-color: #f9ab00; }
    .issue-box.low { border-left-color: #1e8e3e; }
    .label { font-weight: bold; color: #202124; }
    code { background: #f1f3f4; padding: 2px 6px; border-radius: 4px; font-family: 'Roboto Mono', monospace; }
    pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #dadce0; padding: 12px; text-align: left; }
    th { background: #f1f3f4; font-weight: bold; }
    .summary-table tr:last-child { font-weight: bold; background: #e8f0fe; }
    ul { margin: 10px 0; }
    li { margin: 8px 0; }
    .section-critical { border-top: 4px solid #d93025; }
    .section-high { border-top: 4px solid #ea8600; }
    .section-medium { border-top: 4px solid #f9ab00; }
  </style>
</head>
<body>

<h1>Spark Voice Portal - Technical Review</h1>
<p class="subtitle">Deep QA Analysis - February 1, 2026</p>

<h2>Executive Summary</h2>
<p>The Spark Voice Portal is a well-architected voice/chat assistant with three modes: Voice (realtime), Chat (deep thinking), and Notes (transcription). The codebase is functional but has <strong>several critical issues</strong> that could cause crashes, memory leaks, and poor UX in production.</p>

<p><span class="label">Overall Health Assessment:</span> The core functionality works, but the code needs hardening before heavy use. The frontend has memory leaks, missing cleanup handlers, and accessibility gaps. The backend has race conditions and missing error handling in async code.</p>

<h3>Top 5 Critical Issues</h3>
<ol>
  <li><strong>Memory Leaks in Audio Contexts</strong> - AudioContext objects created but never closed (app.js)</li>
  <li><strong>Missing WebSocket Error Recovery</strong> - No reconnection logic for realtime voice mode</li>
  <li><strong>Race Condition in Pending Requests</strong> - Multiple requests can overwrite each other (server.js)</li>
  <li><strong>No Microphone Permission Handling</strong> - App crashes if mic access denied</li>
  <li><strong>Timeout Not Cleared</strong> - speakingTimeout in hybrid-realtime.js can fire after session ends</li>
</ol>

<h2>Code Quality Score: <span class="score">6.5/10</span></h2>
<p>Good foundation, needs polish. Well-structured but lacks defensive programming.</p>

<hr>

<h2 class="section-critical" style="color: #d93025;">Critical Issues (Fix Immediately)</h2>

<div class="issue-box">
  <h3>Issue: Memory Leak - AudioContext Never Closed</h3>
  <p><span class="label">Severity:</span> <span class="critical">Critical</span></p>
  <p><span class="label">Location:</span> <code>public/app.js:418-430</code> (createThinkingSound), <code>:533</code> (playAudioQueueTTS)</p>
  <p><span class="label">Problem:</span> Multiple AudioContext objects are created for thinking sounds and TTS playback, but many are never closed. Each AudioContext consumes system resources and browsers limit the number that can be open.</p>
  <p><span class="label">Impact:</span> After extended use (10-20 voice sessions), the browser will refuse to create new AudioContexts, breaking all audio playback.</p>
  <p><span class="label">Fix:</span> Add <code>ctx.close().catch(() => {})</code> in error handlers and ensure cleanup on all code paths.</p>
  <p><span class="label">Effort:</span> 2 hours</p>
</div>

<div class="issue-box">
  <h3>Issue: No Realtime WebSocket Reconnection</h3>
  <p><span class="label">Severity:</span> <span class="critical">Critical</span></p>
  <p><span class="label">Location:</span> <code>public/app.js:595-627</code> (connectRealtime)</p>
  <p><span class="label">Problem:</span> When the realtime WebSocket disconnects, onclose tries to reconnect, but if the initial connection fails (e.g., server restart), there's no exponential backoff or max retry limit. Also, if onerror fires, the user sees "Connection error" but the app is stuck.</p>
  <p><span class="label">Impact:</span> Voice mode becomes permanently broken after a network hiccup until page refresh.</p>
  <p><span class="label">Fix:</span> Implement exponential backoff with max 5 retries. Show clear error and reset UI after max retries.</p>
  <p><span class="label">Effort:</span> 2 hours</p>
</div>

<div class="issue-box">
  <h3>Issue: Race Condition in Pending Requests Store</h3>
  <p><span class="label">Severity:</span> <span class="critical">Critical</span></p>
  <p><span class="label">Location:</span> <code>src/server.js:343-350</code></p>
  <p><span class="label">Problem:</span> If a user sends a new message while a previous one is still processing, <code>pendingRequests.set(sessionId, {...})</code> overwrites the previous pending request. The old response is lost.</p>
  <p><span class="label">Impact:</span> User loses responses if they send messages too quickly. Confusing UX.</p>
  <p><span class="label">Fix:</span> Use a queue instead of single pending request per session.</p>
  <p><span class="label">Effort:</span> 4 hours</p>
</div>

<div class="issue-box">
  <h3>Issue: Microphone Access Denial Crashes Voice Mode</h3>
  <p><span class="label">Severity:</span> <span class="critical">Critical</span></p>
  <p><span class="label">Location:</span> <code>public/app.js:476-510</code> (startAudioCapture)</p>
  <p><span class="label">Problem:</span> If <code>navigator.mediaDevices.getUserMedia</code> fails (permission denied, no mic, etc.), the function shows a toast and returns false. But the caller doesn't properly clean up - voice mode UI stays active but non-functional.</p>
  <p><span class="label">Impact:</span> User is stuck in broken voice mode state.</p>
  <p><span class="label">Fix:</span> Handle specific error types (NotAllowedError, NotFoundError) with clear messages. Clean up AudioContext on failure. Call stopVoice() to reset UI.</p>
  <p><span class="label">Effort:</span> 1 hour</p>
</div>

<div class="issue-box">
  <h3>Issue: Speaking Timeout Not Cleared on Session End</h3>
  <p><span class="label">Severity:</span> <span class="critical">Critical</span></p>
  <p><span class="label">Location:</span> <code>src/hybrid-realtime.js:166-172</code></p>
  <p><span class="label">Problem:</span> <code>speakingTimeout</code> is set for 30 seconds but may fire after the WebSocket session is closed, causing errors when trying to access closed connections.</p>
  <p><span class="label">Impact:</span> Server errors in logs, potential memory leaks.</p>
  <p><span class="label">Fix:</span> Add <code>clearTimeout(speakingTimeout)</code> in the <code>clientWs.on('close')</code> handler.</p>
  <p><span class="label">Effort:</span> 15 minutes</p>
</div>

<hr>

<h2 class="section-high" style="color: #ea8600;">High Priority Issues</h2>

<div class="issue-box high">
  <h3>Issue: No Timeout on Chat API Requests</h3>
  <p><span class="label">Severity:</span> <span class="high">High</span></p>
  <p><span class="label">Location:</span> <code>src/server.js:504-520</code> (chat function)</p>
  <p><span class="label">Problem:</span> The comment says "No timeout - let Claude take as long as needed" but this can cause requests to hang forever if the gateway is unresponsive.</p>
  <p><span class="label">Impact:</span> Client waits forever with "Thinking..." indicator.</p>
  <p><span class="label">Fix:</span> Add AbortController with 2 minute timeout.</p>
  <p><span class="label">Effort:</span> 1 hour</p>
</div>

<div class="issue-box high">
  <h3>Issue: setInterval for PC Status Never Cleared</h3>
  <p><span class="label">Severity:</span> <span class="high">High</span></p>
  <p><span class="label">Location:</span> <code>public/app.js:855-858</code></p>
  <p><span class="label">Problem:</span> <code>statusInterval</code> is created with <code>setInterval(checkPcStatus, 30000)</code> but never cleared when the page is hidden/backgrounded. On mobile, this wastes battery and network.</p>
  <p><span class="label">Impact:</span> Battery drain on mobile, unnecessary network requests.</p>
  <p><span class="label">Fix:</span> Add visibilitychange event listener to pause/resume polling.</p>
  <p><span class="label">Effort:</span> 30 minutes</p>
</div>

<div class="issue-box high">
  <h3>Issue: Uncaught Promise Rejections in File Extraction</h3>
  <p><span class="label">Severity:</span> <span class="high">High</span></p>
  <p><span class="label">Location:</span> <code>src/server.js:405-415</code></p>
  <p><span class="label">Problem:</span> PDF and DOCX extraction use external libraries (pdf-parse, mammoth) but errors aren't always properly caught. If the file is corrupted, the error may not be user-friendly.</p>
  <p><span class="label">Impact:</span> Cryptic error messages to users, server logs full of stack traces.</p>
  <p><span class="label">Fix:</span> Wrap extractions in try/catch with user-friendly error messages.</p>
  <p><span class="label">Effort:</span> 1 hour</p>
</div>

<div class="issue-box high">
  <h3>Issue: WoL Fast Polling Interval Never Cleared on Success</h3>
  <p><span class="label">Severity:</span> <span class="high">High</span></p>
  <p><span class="label">Location:</span> <code>public/app.js:885-900</code></p>
  <p><span class="label">Problem:</span> If the user clicks the WoL button multiple times before success, multiple fastPoll intervals are created.</p>
  <p><span class="label">Impact:</span> Multiple concurrent polling loops hammering the server.</p>
  <p><span class="label">Fix:</span> Clear existing fastPoll before creating a new one.</p>
  <p><span class="label">Effort:</span> 15 minutes</p>
</div>

<div class="issue-box high">
  <h3>Issue: Missing ARIA Labels for Accessibility</h3>
  <p><span class="label">Severity:</span> <span class="high">High</span></p>
  <p><span class="label">Location:</span> <code>public/index.html</code> (multiple buttons)</p>
  <p><span class="label">Problem:</span> Many buttons lack <code>aria-label</code> attributes. Screen readers can't describe their function.</p>
  <p><span class="label">Impact:</span> App is inaccessible to blind/visually impaired users.</p>
  <p><span class="label">Fix:</span> Add aria-label to all interactive elements.</p>
  <p><span class="label">Effort:</span> 2 hours</p>
</div>

<div class="issue-box high">
  <h3>Issue: Session Cleanup Missing</h3>
  <p><span class="label">Severity:</span> <span class="high">High</span></p>
  <p><span class="label">Location:</span> <code>src/server.js:295-305</code></p>
  <p><span class="label">Problem:</span> The sessions Map grows unbounded. Old sessions are never cleaned up.</p>
  <p><span class="label">Impact:</span> Memory growth over time, potential OOM crash on long-running server.</p>
  <p><span class="label">Fix:</span> Add hourly cleanup of sessions older than 24 hours.</p>
  <p><span class="label">Effort:</span> 30 minutes</p>
</div>

<hr>

<h2 class="section-medium" style="color: #b5850a;">Medium Priority Issues</h2>

<div class="issue-box medium">
  <h3>Issue: Waveform Bars Hardcoded (50 divs)</h3>
  <p><span class="label">Severity:</span> <span class="medium">Medium</span></p>
  <p><span class="label">Location:</span> <code>public/index.html:603-605</code></p>
  <p><span class="label">Problem:</span> 50 waveform bar divs are hardcoded in HTML, each with individual CSS animation delays.</p>
  <p><span class="label">Impact:</span> Larger HTML payload, harder to modify animation.</p>
  <p><span class="label">Effort:</span> 30 minutes</p>
</div>

<div class="issue-box medium">
  <h3>Issue: Console.log Statements in Production</h3>
  <p><span class="label">Severity:</span> <span class="medium">Medium</span></p>
  <p><span class="label">Location:</span> Throughout all files</p>
  <p><span class="label">Problem:</span> Heavy console logging in production code.</p>
  <p><span class="label">Impact:</span> Performance overhead, exposes internal state.</p>
  <p><span class="label">Effort:</span> 2 hours</p>
</div>

<div class="issue-box medium">
  <h3>Issue: Theme Toggle Initial State</h3>
  <p><span class="label">Severity:</span> <span class="medium">Medium</span></p>
  <p><span class="label">Location:</span> <code>public/app.js:32-48</code></p>
  <p><span class="label">Problem:</span> First theme toggle might not do what user expects.</p>
  <p><span class="label">Effort:</span> 15 minutes</p>
</div>

<div class="issue-box medium">
  <h3>Issue: Double-Click Prevention Inconsistent</h3>
  <p><span class="label">Severity:</span> <span class="medium">Medium</span></p>
  <p><span class="label">Location:</span> <code>public/app.js:841-847</code></p>
  <p><span class="label">Problem:</span> Can interfere with legitimate rapid interactions.</p>
  <p><span class="label">Effort:</span> 1 hour</p>
</div>

<div class="issue-box medium">
  <h3>Issue: Long Message Handling</h3>
  <p><span class="label">Severity:</span> <span class="medium">Medium</span></p>
  <p><span class="label">Location:</span> <code>public/app.js:125-140</code></p>
  <p><span class="label">Problem:</span> Very long messages (10,000+ chars) cause performance issues.</p>
  <p><span class="label">Effort:</span> 1 hour</p>
</div>

<hr>

<h2>Low Priority / Nice to Have</h2>

<ul>
  <li><strong>Magic Numbers Scattered:</strong> Hardcoded values like 24000, 50000 - 2 hours</li>
  <li><strong>CSS Variables Duplicated:</strong> Dark mode defined twice - 1 hour</li>
  <li><strong>No Loading State for Shortcuts:</strong> No feedback on click - 30 min</li>
  <li><strong>File Size Limit Not Enforced:</strong> Large files crash browser - 15 min</li>
</ul>

<hr>

<h2>Architecture Recommendations</h2>

<ol>
  <li><strong>Separate CSS from HTML:</strong> Move 600+ lines of CSS to a separate styles.css file.</li>
  <li><strong>Add TypeScript:</strong> Better IDE support and catching bugs early. WebSocket message types especially need better typing.</li>
  <li><strong>State Management:</strong> Currently 30+ global variables. Consider Zustand or central state object.</li>
  <li><strong>WebSocket Message Validation:</strong> Add Zod or similar for validating messages on both client and server.</li>
  <li><strong>Error Boundary Pattern:</strong> Wrap major UI sections to prevent one component's error from crashing the whole app.</li>
</ol>

<hr>

<h2 style="color: #d93025;">Security Considerations</h2>

<table>
  <tr>
    <th>Issue</th>
    <th>Risk</th>
    <th>Recommendation</th>
  </tr>
  <tr>
    <td>No XSS Sanitization</td>
    <td>formatMessage lacks proper sanitization</td>
    <td>Use DOMPurify for all HTML rendering</td>
  </tr>
  <tr>
    <td>File Content Over WebSocket</td>
    <td>No encryption beyond HTTPS</td>
    <td>Consider additional encryption for sensitive docs</td>
  </tr>
  <tr>
    <td>Session ID in LocalStorage</td>
    <td>XSS could steal session IDs</td>
    <td>Consider httpOnly cookies instead</td>
  </tr>
  <tr>
    <td>API Keys in Config Files</td>
    <td>Server compromise exposes all keys</td>
    <td>Use environment variables or secrets manager</td>
  </tr>
</table>

<hr>

<h2>Performance Opportunities</h2>

<ul>
  <li><strong>Audio Worklet:</strong> Replace deprecated ScriptProcessorNode for better performance (4 hours)</li>
  <li><strong>Debounce PC Status:</strong> Only check when user is actively using app</li>
  <li><strong>Lazy Load History:</strong> Implement pagination for large message histories</li>
  <li><strong>Image Compression:</strong> Resize/compress images before upload</li>
</ul>

<hr>

<h2>Summary of Effort</h2>

<table class="summary-table">
  <tr>
    <th>Priority</th>
    <th>Issue Count</th>
    <th>Total Effort</th>
  </tr>
  <tr>
    <td><span class="critical">Critical</span></td>
    <td>5</td>
    <td>~10 hours</td>
  </tr>
  <tr>
    <td><span class="high">High</span></td>
    <td>6</td>
    <td>~7 hours</td>
  </tr>
  <tr>
    <td><span class="medium">Medium</span></td>
    <td>6</td>
    <td>~7 hours</td>
  </tr>
  <tr>
    <td><span class="low">Low</span></td>
    <td>4</td>
    <td>~4 hours</td>
  </tr>
  <tr>
    <td><strong>TOTAL</strong></td>
    <td><strong>21</strong></td>
    <td><strong>~28 hours</strong></td>
  </tr>
</table>

<h3>Recommended Approach</h3>
<p>Fix all <strong>Critical issues first</strong> (1 day), then <strong>High priority</strong> (1 day), then Medium/Low over time during regular development.</p>

</body>
</html>
